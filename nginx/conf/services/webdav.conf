# WebDAV 文件服務配置
# 支援大文件上傳下載，包含 API Key 認證

location ~ ^/webdav/?(.*)$ {
    limit_req zone=webdav_limit burst=100 nodelay;
    
    # 設定服務名稱變數，讓 auth_request 可以驗證服務的 api key
    set $service_name "webdav";

    # 使用 FastAPI 服務進行 API Key 驗證
    auth_request /auth-internal;
    
    # 當認證失敗時返回自定義錯誤
    error_page 401 = @auth_error;
    error_page 403 = @auth_error;
    
    set $upstream_webdav webdav;
    # 修復：直接代理到 webdav 容器的根路徑，讓 WebDAV 處理路徑
    proxy_pass http://$upstream_webdav:80;
    
    # 引入標準代理頭部設定
    include /etc/nginx/conf.d/templates/proxy-headers.conf;
    
    # 添加響應標頭來識別問題
    add_header X-WebDAV-Request-URI $request_uri;
    add_header X-WebDAV-Method $request_method;

    # WebDAV 特殊配置
    client_max_body_size 5G;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Forwarded-Server $host;
    proxy_redirect off;
    proxy_buffering off;
    proxy_request_buffering off;
}
