resolver 127.0.0.11 valid=30s;

# 全局设置，防止上传大文件时的默认限制
client_max_body_size 10G;

# 定義不同的 rate limit zones
limit_req_zone $binary_remote_addr zone=webdav_limit:10m rate=100r/s;     # WebDAV: 寬鬆
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/s;       # Auth: 適中  
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=20r/s;        # API: 適中
limit_req_zone $binary_remote_addr zone=default_limit:10m rate=5r/s;     # 預設: 嚴格


server {
    listen 80;
    server_name novis.tplinkdns.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

log_format detailed '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '$request_time $upstream_response_time';


server {
    listen 443 ssl;
    server_name novis.tplinkdns.com;

    access_log /var/log/nginx/access.log detailed;
    error_log /var/log/nginx/error.log warn;

    # TLS 優化配置
    ssl_certificate /etc/letsencrypt/live/novis.tplinkdns.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/novis.tplinkdns.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3; # 只允許安全協議
    ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305; # 強加密演算法
    ssl_prefer_server_ciphers on; # 伺服器優先選擇加密演算法
    ssl_session_cache shared:SSL:10m; # 啟用會話快取
    ssl_session_timeout 1d; # 會話快取有效期
    ssl_session_tickets off; # 禁用會話票證，減少風險
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always; # 啟用 HSTS

    # 內部認證端點 (僅供 nginx auth_request 使用)
    location = /auth-internal {
        internal;
        proxy_pass http://gateway:8000/auth/verify-api-key;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-API-Key $http_x_api_key;
        proxy_set_header X-Service-Name $service_name;
        # 確保不傳遞請求體到認證服務
        client_max_body_size 0;
    }

    location ~ ^/webdav/?(.*)$ {
        limit_req zone=webdav_limit burst=100 nodelay;
        
        # 設定服務名稱變數，讓 auth_request 可以驗證服務的 api key
        set $service_name "webdav";

        # 使用 FastAPI 服務進行 API Key 驗證
        auth_request /auth-internal;
        
        # 當認證失敗時返回自定義錯誤
        error_page 401 = @auth_error;
        error_page 403 = @auth_error;
        
        set $upstream_webdav webdav;
        # 修復：直接代理到 webdav 容器的根路徑，讓 WebDAV 處理路徑
        proxy_pass http://$upstream_webdav:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 添加響應標頭來識別問題
        add_header X-WebDAV-Request-URI $request_uri;
        add_header X-WebDAV-Method $request_method;

        client_max_body_size 5G;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;

        # WebDAV 特殊配置
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Forwarded-Server $host;
        proxy_redirect off;
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Hugo 網站服務
    location /blog {
        limit_req zone=default_limit burst=10 nodelay;
        
        set $upstream_hugo hugo;
        proxy_pass http://$upstream_hugo:1313;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Hugo 特殊配置
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_buffering off;
        
        # 處理靜態資源
        proxy_redirect off;
    }

    # Hugo 靜態資源 (CSS, JS, 圖片等)
    location /blog/assets/ {
        limit_req zone=default_limit burst=20 nodelay;
        
        set $upstream_hugo hugo;
        proxy_pass http://$upstream_hugo:1313;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 靜態資源快取
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 認證錯誤處理
    location @auth_error {
        add_header Content-Type application/json always;
        return 401 '{"error": "Invalid or missing API Key", "message": "Please provide a valid X-API-Key header"}';
    }

    # 服務狀態端點 - 重新導向到 blog
    location = / {
        return 301 /blog;
    }

    location /dashboard {
        limit_req zone=api_limit burst=30 nodelay;

        proxy_pass http://gateway:8000; # FastAPI 容器名稱
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 認證相關端點 (對外)
    location /auth {
        limit_req zone=auth_limit burst=20 nodelay;

        proxy_pass http://gateway:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API 端點 (為未來的 API 服務預留)
    location /api {
        proxy_pass http://gateway:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 禁止對外訪問內部管理端點
    location /internal {
        return 403 "Access denied: Internal endpoints not accessible from external network";
    }
}

# TODO: 這邊之後再設定，如果把 location 移動到 443 的設定裡面，是可以直接訪問的。
# server {
#     listen 8443 ssl;
#     server_name novis.tplinkdns.com;

#     ssl_certificate /etc/letsencrypt/live/novis.tplinkdns.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/novis.tplinkdns.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3; # 只允許安全協議
#     ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305; 
#     # 強加密演算法
#     ssl_prefer_server_ciphers on; # 伺服器優先選擇加密演算法
#     ssl_session_cache shared:SSL:10m; # 啟用會話快取
#     ssl_session_timeout 1d; # 會話快取有效期
#     ssl_session_tickets off; # 禁用會話票證，減少風險
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always; # 啟用 HSTS
    
#     # Immich 照片管理服務
#     location / {
#         set $upstream_immich immich_server;
#         proxy_pass http://$upstream_immich:2283$request_uri;
        
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;

#         # 重要：添加 session 支持
#         proxy_set_header X-Forwarded-Host $host;
#         proxy_set_header X-Forwarded-Server $host;
        
#         # WebSocket 支援
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
        
#         # 文件上傳支援
#         client_max_body_size 50000M;
        
#         # 不緩存，確保正確的內容類型
#         proxy_buffering off;
#         proxy_request_buffering off;
        
#         # 超時設定
#         proxy_read_timeout 600s;
#         proxy_send_timeout 600s;
#     }
# }