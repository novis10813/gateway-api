# 認證相關端點配置
# 內部認證端點和錯誤處理機制

# 內部認證端點 (僅供 nginx auth_request 使用)
location = /auth-internal {
    internal;
    proxy_pass http://gateway:8000/auth/verify-api-key;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header X-API-Key $http_x_api_key;
    proxy_set_header X-Service-Name $service_name;
    # 確保不傳遞請求體到認證服務
    client_max_body_size 0;
}

# 認證錯誤處理
location @auth_error {
    add_header Content-Type application/json always;
    return 401 '{"error": "Invalid or missing API Key", "message": "Please provide a valid X-API-Key header"}';
}

# 禁止對外訪問內部管理端點
location /internal {
    return 403 "Access denied: Internal endpoints not accessible from external network";
}
